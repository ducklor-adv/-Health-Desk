<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Super Admin - Health Desk</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Prompt', sans-serif; background: #F3F4F6; min-height: 100vh; padding-bottom: 75px; }

        /* Header */
        .top { background: linear-gradient(135deg, #7C3AED, #4F46E5); padding: 0.75rem 1rem; color: white; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 1.1rem; font-weight: 700; }
        .top-actions { display: flex; align-items: center; gap: 0.5rem; }
        .top-actions button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.3rem; }
        .role-badge { font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 0.15rem 0.5rem; border-radius: 20px; margin-top: 0.2rem; display: inline-block; }
        .current-date { font-size: 0.72rem; opacity: 0.85; margin-top: 0.15rem; }

        /* Content */
        .box { padding: 0.75rem; }

        /* Tab Navigation */
        .tab-nav { display: flex; background: white; border-radius: 10px; border: 1px solid #E5E7EB; margin-bottom: 0.75rem; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 0.6rem 0.3rem; border: none; background: transparent; font-family: 'Prompt', sans-serif; font-size: 0.75rem; font-weight: 600; color: #6B7280; cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: #4F46E5; border-bottom-color: #4F46E5; background: #EEF2FF; }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Section Title */
        .section-title { font-size: 0.85rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; }
        .stat-card { background: white; border-radius: 10px; padding: 0.75rem; border: 1px solid #E5E7EB; }
        .stat-icon { font-size: 1.2rem; }
        .stat-label { font-size: 0.72rem; color: #6B7280; margin-top: 0.1rem; }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: #111827; }

        /* Summary Card */
        .summary-card { background: white; padding: 0.75rem; border-radius: 10px; border: 1px solid #E5E7EB; }

        /* Staff Cards */
        .staff-card { background: white; border-radius: 10px; padding: 0.75rem; border: 1px solid #E5E7EB; margin-bottom: 0.5rem; }
        .staff-header { display: flex; align-items: center; gap: 0.6rem; }
        .staff-avatar { width: 40px; height: 40px; border-radius: 50%; background: #4F46E5; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; flex-shrink: 0; }
        .staff-info { flex: 1; min-width: 0; }
        .staff-name { font-size: 0.85rem; font-weight: 600; color: #111827; }
        .staff-meta { font-size: 0.72rem; color: #6B7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .staff-status { font-size: 0.68rem; padding: 0.1rem 0.4rem; border-radius: 10px; font-weight: 600; }
        .status-active { background: #D1FAE5; color: #065F46; }
        .status-inactive { background: #FEE2E2; color: #991B1B; }
        .staff-actions { display: flex; gap: 0.4rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .staff-actions button { font-family: 'Prompt', sans-serif; font-size: 0.72rem; padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid #E5E7EB; background: #F9FAFB; cursor: pointer; font-weight: 500; }
        .staff-actions button:hover { background: #E5E7EB; }

        /* Buttons */
        .btn-add { display: block; width: 100%; padding: 0.6rem; border: 2px dashed #D1D5DB; background: white; border-radius: 10px; font-family: 'Prompt', sans-serif; font-size: 0.82rem; font-weight: 600; color: #4F46E5; cursor: pointer; margin-bottom: 0.75rem; }
        .btn-add:hover { background: #EEF2FF; border-color: #4F46E5; }

        .btn-primary { background: #4F46E5; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-family: 'Prompt', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; }
        .btn-primary:hover { background: #4338CA; }
        .btn-danger { background: #EF4444; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-family: 'Prompt', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; margin-left: 0.5rem; }
        .btn-danger:hover { background: #DC2626; }
        .btn-success { background: #10B981; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-family: 'Prompt', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; }
        .btn-success:hover { background: #059669; }
        .btn-refresh { background: white; border: 1px solid #E5E7EB; padding: 0.4rem 0.8rem; border-radius: 6px; font-family: 'Prompt', sans-serif; font-size: 0.78rem; cursor: pointer; margin-bottom: 0.5rem; }

        /* Action Card */
        .action-card { background: white; padding: 0.75rem; border-radius: 10px; border: 1px solid #E5E7EB; margin-bottom: 0.5rem; }
        .action-card p { font-size: 0.78rem; color: #6B7280; margin-bottom: 0.5rem; }

        /* Data Log */
        .data-log { background: #1F2937; color: #10B981; padding: 0.75rem; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.75rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }

        /* Audit Log */
        .audit-item { background: white; border-radius: 8px; padding: 0.6rem 0.75rem; border: 1px solid #E5E7EB; margin-bottom: 0.4rem; }
        .audit-header { display: flex; align-items: center; gap: 0.4rem; }
        .audit-icon { font-size: 1rem; }
        .audit-action { font-size: 0.8rem; font-weight: 500; color: #111827; }
        .audit-meta { font-size: 0.7rem; color: #9CA3AF; margin-top: 0.15rem; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: flex-start; justify-content: center; padding-top: 8vh; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 1.25rem; width: 92%; max-width: 450px; max-height: 82vh; overflow-y: auto; }
        .modal-content h3 { font-size: 1rem; font-weight: 700; margin-bottom: 0.75rem; color: #111827; }
        .form-group { margin-bottom: 0.6rem; }
        .form-group label { display: block; font-size: 0.78rem; font-weight: 600; color: #374151; margin-bottom: 0.2rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem 0.6rem; border: 1px solid #D1D5DB; border-radius: 8px; font-family: 'Prompt', sans-serif; font-size: 0.82rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4F46E5; box-shadow: 0 0 0 2px rgba(79,70,229,0.15); }
        .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; margin-top: 0.75rem; }
        .modal-actions button { padding: 0.6rem; border-radius: 8px; font-family: 'Prompt', sans-serif; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #F3F4F6; color: #374151; border: 1px solid #D1D5DB; }
        .btn-save { background: #4F46E5; color: white; border: none; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #E5E7EB; display: grid; grid-template-columns: repeat(3, 1fr); z-index: 1000; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; padding: 0.5rem 0; text-decoration: none; color: #6B7280; font-size: 0.7rem; gap: 0.15rem; }
        .nav-btn.on { color: #4F46E5; font-weight: 600; }
        .nav-icon { font-size: 1.2rem; }
        .nav-text { font-size: 0.68rem; }

        /* Empty state */
        .empty-state { text-align: center; color: #9CA3AF; padding: 2rem; font-size: 0.85rem; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="top">
        <div class="top-row">
            <div>
                <div class="title">üõ°Ô∏è Super Admin</div>
                <div class="role-badge" id="userRoleDisplay">-</div>
                <div class="current-date" id="currentDate"></div>
            </div>
            <div class="top-actions">
                <button onclick="toggleNotifications()" style="position:relative;">
                    üîî<span id="notifBadge" style="display:none; position:absolute; top:-2px; right:-4px; background:#EF4444; color:white; font-size:0.6rem; font-weight:700; min-width:14px; height:14px; border-radius:7px; display:flex; align-items:center; justify-content:center; padding:0 2px;"></span>
                </button>
                <button onclick="logout()">üö™</button>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div id="notifPanel" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:white; z-index:2000; overflow-y:auto;"></div>

    <!-- Main Content -->
    <div class="box">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <button class="tab-btn" data-tab="staff" onclick="switchTab('staff')">üë®‚Äç‚öïÔ∏è ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
            <button class="tab-btn" data-tab="data" onclick="switchTab('data')">üíæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="tab-btn" data-tab="audit" onclick="switchTab('audit')">üìú Log</button>
        </div>

        <!-- Tab 1: Overview -->
        <div class="tab-panel active" id="panel-overview">
            <div class="section-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö</div>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value" id="statPatients">-</div><div class="stat-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                <div class="stat-card"><div class="stat-icon">üë®‚Äç‚öïÔ∏è</div><div class="stat-value" id="statStaff">-</div><div class="stat-label">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div></div>
                <div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-value" id="statAppointments">-</div><div class="stat-label">‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div></div>
                <div class="stat-card"><div class="stat-icon">üö®</div><div class="stat-value" id="statRiskHigh">-</div><div class="stat-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</div></div>
                <div class="stat-card"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value" id="statRiskMedium">-</div><div class="stat-label">‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</div></div>
                <div class="stat-card"><div class="stat-icon">üí¨</div><div class="stat-value" id="statConversations">-</div><div class="stat-label">‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</div></div>
            </div>
            <div class="summary-card">
                <div class="section-title">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
                <div id="summaryContent" style="font-size:0.8rem; color:#374151;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <!-- Tab 2: Staff Management -->
        <div class="tab-panel" id="panel-staff">
            <div class="section-title">üë®‚Äç‚öïÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div>
            <button class="btn-add" onclick="openAddStaffModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà</button>
            <div id="staffList"><div class="empty-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
        </div>

        <!-- Tab 3: Data Management -->
        <div class="tab-panel" id="panel-data">
            <div class="section-title">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
            <div class="action-card" id="dataSummary">
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <div class="section-title" style="margin-top:0.75rem;">üå± ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</div>
            <div class="action-card">
                <p>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (50 ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ + ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà + ‡πÅ‡∏ä‡∏ó + ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)</p>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    <button class="btn-primary" onclick="doSeedData()">üå± Seed ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
                    <button class="btn-danger" onclick="doClearData()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </div>

            <div class="section-title" style="margin-top:0.75rem;">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á / ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <div class="action-card">
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.5rem;">
                    <button class="btn-success" onclick="exportData()">üì• Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (JSON)</button>
                </div>
                <div>
                    <label style="font-size:0.78rem; font-weight:600; color:#374151;">üì§ Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
                    <input type="file" id="importFile" accept=".json" onchange="importData(this)" style="font-size:0.78rem; margin-top:0.3rem;">
                </div>
            </div>

            <div class="section-title" style="margin-top:0.75rem;">üìù Console Log</div>
            <div class="data-log" id="dataLog">Ready.</div>
        </div>

        <!-- Tab 4: Audit Log -->
        <div class="tab-panel" id="panel-audit">
            <div class="section-title">üìú ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏∞‡∏ö‡∏ö</div>
            <button class="btn-refresh" onclick="loadAuditLog()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            <div id="auditLogList"><div class="empty-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div class="modal-overlay" id="staffModal">
        <div class="modal-content">
            <h3 id="staffModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h3>
            <input type="hidden" id="staffEditId">
            <div class="form-group">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                <input type="text" id="staffName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="form-group">
                <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• *</label>
                <input type="email" id="staffEmail" placeholder="user@health.go.th">
            </div>
            <div class="form-group">
                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                <input type="tel" id="staffPhone" placeholder="0XX-XXX-XXXX">
            </div>
            <div class="form-group">
                <label>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                <select id="staffRole">
                    <option value="worker">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</option>
                    <option value="doctor">‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
                    <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                    <option value="superadmin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</option>
                </select>
            </div>
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input type="text" id="staffLicenseNo" placeholder="‡∏ß.XXXXX">
            </div>
            <div class="form-group">
                <label>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</label>
                <input type="text" id="staffHealthCenter" value="‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡πÉ‡∏à">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeStaffModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-save" onclick="saveStaff()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav"></nav>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/firebase-service.js"></script>
    <script src="../js/seed-data.js"></script>
    <script src="../js/mock-data.js"></script>
    <script src="../js/mock-data-chat.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/chat.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/nav-helper.js"></script>

    <script>
        // ===== Global State =====
        var allStaffData = [];
        var roleLabels = {
            worker: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç',
            doctor: '‡πÅ‡∏û‡∏ó‡∏¢‡πå',
            admin: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
            superadmin: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î'
        };

        // ===== Tab Navigation =====
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
            });
            document.querySelectorAll('.tab-panel').forEach(function(panel) {
                panel.classList.toggle('active', panel.id === 'panel-' + tabId);
            });
        }

        // ===== Tab 1: Overview Stats =====
        function loadOverviewStats() {
            if (typeof FirebaseService !== 'undefined' && FirebaseService.getSystemStats) {
                FirebaseService.getSystemStats().then(function(stats) {
                    renderStats(stats);
                }).catch(function() {
                    renderStatsFallback();
                });
            } else {
                renderStatsFallback();
            }
        }

        function renderStatsFallback() {
            var patients = typeof mockPatients !== 'undefined' ? mockPatients : [];
            var appointments = typeof mockAppointments !== 'undefined' ? mockAppointments : [];
            renderStats({
                totalPatients: patients.length,
                activeStaff: Object.keys(mockUsers).length,
                scheduledAppointments: appointments.filter(function(a) { return a.status === 'scheduled'; }).length,
                riskHigh: patients.filter(function(p) { return p.riskLevel === 'high'; }).length,
                riskMedium: patients.filter(function(p) { return p.riskLevel === 'medium'; }).length,
                totalConversations: 0
            });
        }

        function renderStats(stats) {
            document.getElementById('statPatients').textContent = stats.totalPatients || 0;
            document.getElementById('statStaff').textContent = stats.activeStaff || 0;
            document.getElementById('statAppointments').textContent = stats.scheduledAppointments || stats.totalAppointments || 0;
            document.getElementById('statRiskHigh').textContent = stats.riskHigh || 0;
            document.getElementById('statRiskMedium').textContent = stats.riskMedium || 0;
            document.getElementById('statConversations').textContent = stats.totalConversations || 0;

            document.getElementById('summaryContent').textContent =
                '‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ' + (stats.totalPatients || 0) + ' ‡∏£‡∏≤‡∏¢ ' +
                '(‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á ' + (stats.riskHigh || 0) + ' ‡∏£‡∏≤‡∏¢, ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á ' + (stats.riskMedium || 0) + ' ‡∏£‡∏≤‡∏¢) ' +
                '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ' + (stats.activeStaff || 0) + ' ‡∏Ñ‡∏ô ' +
                '‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ ' + (stats.scheduledAppointments || stats.totalAppointments || 0) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        }

        // ===== Tab 2: Staff Management =====
        function loadStaff() {
            if (typeof FirebaseService !== 'undefined' && FirebaseService.getAllStaffIncludeInactive) {
                FirebaseService.getAllStaffIncludeInactive().then(function(staff) {
                    allStaffData = staff;
                    renderStaffList(staff);
                }).catch(function() {
                    loadStaffFallback();
                });
            } else {
                loadStaffFallback();
            }
        }

        function loadStaffFallback() {
            allStaffData = Object.keys(mockUsers).map(function(email) {
                var u = mockUsers[email];
                return { id: u.id, name: u.name, email: email, role: u.role, roleLabel: u.roleLabel, status: 'active', phone: '' };
            });
            renderStaffList(allStaffData);
        }

        function renderStaffList(staffList) {
            if (!staffList.length) {
                document.getElementById('staffList').innerHTML = '<div class="empty-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div>';
                return;
            }
            var html = '';
            staffList.forEach(function(s) {
                var statusClass = s.status === 'active' ? 'status-active' : 'status-inactive';
                var statusText = s.status === 'active' ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                var toggleText = s.status === 'active' ? '‚è∏Ô∏è ‡∏õ‡∏¥‡∏î' : '‚ñ∂Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î';
                var initial = s.name ? s.name.substring(0, 2) : '??';
                var roleName = roleLabels[s.role] || s.role;

                html += '<div class="staff-card">' +
                    '<div class="staff-header">' +
                    '<div class="staff-avatar">' + initial + '</div>' +
                    '<div class="staff-info">' +
                    '<div class="staff-name">' + s.name + '</div>' +
                    '<div class="staff-meta">' + (s.email || '') + ' | ' + roleName + '</div>' +
                    '<span class="staff-status ' + statusClass + '">' + statusText + '</span>' +
                    '</div></div>' +
                    '<div class="staff-actions">' +
                    '<button onclick="editStaff(\'' + s.id + '\')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>' +
                    '<button onclick="toggleStaffStatus(\'' + s.id + '\', \'' + s.status + '\')">' + toggleText + '</button>' +
                    '<button onclick="confirmDeleteStaff(\'' + s.id + '\', \'' + s.name + '\')">üóëÔ∏è ‡∏•‡∏ö</button>' +
                    '</div></div>';
            });
            document.getElementById('staffList').innerHTML = html;
        }

        function openAddStaffModal() {
            document.getElementById('staffModalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('staffEditId').value = '';
            document.getElementById('staffName').value = '';
            document.getElementById('staffEmail').value = '';
            document.getElementById('staffPhone').value = '';
            document.getElementById('staffRole').value = 'worker';
            document.getElementById('staffLicenseNo').value = '';
            document.getElementById('staffHealthCenter').value = '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡πÉ‡∏à';
            document.getElementById('staffModal').classList.add('show');
        }

        function editStaff(staffId) {
            var staff = allStaffData.find(function(s) { return s.id === staffId; });
            if (!staff) return;
            document.getElementById('staffModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
            document.getElementById('staffEditId').value = staffId;
            document.getElementById('staffName').value = staff.name || '';
            document.getElementById('staffEmail').value = staff.email || '';
            document.getElementById('staffPhone').value = staff.phone || '';
            document.getElementById('staffRole').value = staff.role || 'worker';
            document.getElementById('staffLicenseNo').value = staff.licenseNo || '';
            document.getElementById('staffHealthCenter').value = staff.healthCenter || '';
            document.getElementById('staffModal').classList.add('show');
        }

        function closeStaffModal() {
            document.getElementById('staffModal').classList.remove('show');
        }

        function saveStaff() {
            var editId = document.getElementById('staffEditId').value;
            var name = document.getElementById('staffName').value.trim();
            var email = document.getElementById('staffEmail').value.trim();
            var phone = document.getElementById('staffPhone').value.trim();
            var role = document.getElementById('staffRole').value;
            var licenseNo = document.getElementById('staffLicenseNo').value.trim();
            var healthCenter = document.getElementById('staffHealthCenter').value.trim();

            if (!name || !email) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•');
                return;
            }

            var data = {
                name: name,
                email: email,
                phone: phone,
                role: role,
                roleLabel: roleLabels[role] || role,
                licenseNo: licenseNo,
                healthCenter: healthCenter
            };

            var user = JSON.parse(localStorage.getItem('healthdesk_user'));

            if (typeof FirebaseService !== 'undefined') {
                if (editId) {
                    FirebaseService.updateStaff(editId, data).then(function() {
                        if (FirebaseService.addAuditLog) {
                            FirebaseService.addAuditLog({
                                action: 'update_staff',
                                targetId: editId,
                                targetName: name,
                                performedBy: user ? user.name : 'unknown',
                                details: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ' + name
                            });
                        }
                        alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                        closeStaffModal();
                        loadStaff();
                    }).catch(function(err) {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                    });
                } else {
                    data.status = 'active';
                    FirebaseService.createStaff(data).then(function(newId) {
                        if (FirebaseService.addAuditLog) {
                            FirebaseService.addAuditLog({
                                action: 'create_staff',
                                targetId: newId,
                                targetName: name,
                                performedBy: user ? user.name : 'unknown',
                                details: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà ' + name + ' (' + (roleLabels[role] || role) + ')'
                            });
                        }
                        alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                        closeStaffModal();
                        loadStaff();
                    }).catch(function(err) {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                    });
                }
            } else {
                alert('Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
            }
        }

        function toggleStaffStatus(staffId, currentStatus) {
            var newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            var actionText = newStatus === 'active' ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£' + actionText + '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ?')) return;

            if (typeof FirebaseService !== 'undefined') {
                FirebaseService.updateStaff(staffId, { status: newStatus }).then(function() {
                    var user = JSON.parse(localStorage.getItem('healthdesk_user'));
                    if (FirebaseService.addAuditLog) {
                        FirebaseService.addAuditLog({
                            action: 'toggle_staff_status',
                            targetId: staffId,
                            performedBy: user ? user.name : 'unknown',
                            details: actionText + '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ID: ' + staffId
                        });
                    }
                    loadStaff();
                });
            }
        }

        function confirmDeleteStaff(staffId, staffName) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà "' + staffName + '" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)')) return;

            if (typeof FirebaseService !== 'undefined') {
                FirebaseService.deleteStaff(staffId).then(function() {
                    var user = JSON.parse(localStorage.getItem('healthdesk_user'));
                    if (FirebaseService.addAuditLog) {
                        FirebaseService.addAuditLog({
                            action: 'delete_staff',
                            targetId: staffId,
                            targetName: staffName,
                            performedBy: user ? user.name : 'unknown',
                            details: '‡∏•‡∏ö (‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô) ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ' + staffName
                        });
                    }
                    alert('‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    loadStaff();
                });
            }
        }

        // ===== Tab 3: Data Management =====
        function loadDataSummary() {
            if (typeof FirebaseService !== 'undefined' && FirebaseService.getSystemStats) {
                FirebaseService.getSystemStats().then(function(stats) {
                    document.getElementById('dataSummary').innerHTML =
                        '<p style="font-size:0.82rem; color:#111827; font-weight:600;">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>' +
                        '<p>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: <strong>' + stats.totalPatients + '</strong> ‡∏£‡∏≤‡∏¢ | ' +
                        '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: <strong>' + stats.totalStaff + '</strong> ‡∏Ñ‡∏ô | ' +
                        '‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢: <strong>' + stats.totalAppointments + '</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | ' +
                        '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: <strong>' + stats.totalNotifications + '</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                }).catch(function() {
                    document.getElementById('dataSummary').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>';
                });
            } else {
                var patients = typeof mockPatients !== 'undefined' ? mockPatients : [];
                document.getElementById('dataSummary').innerHTML =
                    '<p style="font-size:0.82rem; color:#111827; font-weight:600;">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Fallback Mode)</p>' +
                    '<p>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: <strong>' + patients.length + '</strong> ‡∏£‡∏≤‡∏¢ (mock data)</p>';
            }
        }

        function doSeedData() {
            if (!confirm('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö')) return;
            dataLog('Starting seed...');

            if (typeof SeedData !== 'undefined' && SeedData.seedAll) {
                SeedData.seedAll().then(function() {
                    dataLog('Seed complete!');
                    var user = JSON.parse(localStorage.getItem('healthdesk_user'));
                    if (typeof FirebaseService !== 'undefined' && FirebaseService.addAuditLog) {
                        FirebaseService.addAuditLog({
                            action: 'seed_data',
                            performedBy: user ? user.name : 'unknown',
                            details: 'Seed ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö'
                        });
                    }
                    loadOverviewStats();
                    loadDataSummary();
                    alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                }).catch(function(e) {
                    dataLog('Seed failed: ' + e.message);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
                });
            } else {
                dataLog('SeedData module not loaded');
                alert('SeedData module ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }
        }

        function doClearData() {
            if (!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Firestore?\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!')) return;
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;

            dataLog('Clearing all data...');
            if (typeof SeedData !== 'undefined' && SeedData.clearAll) {
                SeedData.clearAll().then(function() {
                    dataLog('All data cleared.');
                    var user = JSON.parse(localStorage.getItem('healthdesk_user'));
                    if (typeof FirebaseService !== 'undefined' && FirebaseService.addAuditLog) {
                        FirebaseService.addAuditLog({
                            action: 'clear_all_data',
                            performedBy: user ? user.name : 'unknown',
                            details: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'
                        });
                    }
                    loadOverviewStats();
                    loadDataSummary();
                    alert('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }).catch(function(e) {
                    dataLog('Clear failed: ' + e.message);
                });
            } else {
                dataLog('SeedData module not loaded');
            }
        }

        function exportData() {
            dataLog('Exporting...');
            if (typeof FirebaseService !== 'undefined' && FirebaseService.exportAllData) {
                FirebaseService.exportAllData().then(function(data) {
                    var json = JSON.stringify(data, null, 2);
                    var blob = new Blob([json], { type: 'application/json' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'healthdesk-backup-' + new Date().toISOString().split('T')[0] + '.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    dataLog('Export complete: ' + (data.patients ? data.patients.length : 0) + ' patients, ' + (data.staff ? data.staff.length : 0) + ' staff');

                    var user = JSON.parse(localStorage.getItem('healthdesk_user'));
                    FirebaseService.addAuditLog({
                        action: 'export_data',
                        performedBy: user ? user.name : 'unknown',
                        details: 'Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (' + (data.patients ? data.patients.length : 0) + ' patients)'
                    });
                }).catch(function(err) {
                    dataLog('Export failed: ' + err.message);
                });
            } else {
                // Fallback: export mock data
                var patients = typeof mockPatients !== 'undefined' ? mockPatients : [];
                var data = { patients: patients, exportDate: new Date().toISOString(), system: 'Health Desk (fallback)' };
                var json = JSON.stringify(data, null, 2);
                var blob = new Blob([json], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'healthdesk-backup-' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                URL.revokeObjectURL(url);
                dataLog('Export complete (fallback mode): ' + patients.length + ' patients');
            }
        }

        function importData(input) {
            if (!input.files || !input.files[0]) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    var pCount = data.patients ? data.patients.length : 0;
                    var sCount = data.staff ? data.staff.length : 0;
                    dataLog('File loaded: ' + pCount + ' patients, ' + sCount + ' staff');
                    alert('‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‡∏û‡∏ö ' + pCount + ' ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢, ' + sCount + ' ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà\n(‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå import ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤)');
                } catch (err) {
                    dataLog('Invalid JSON: ' + err.message);
                    alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            };
            reader.readAsText(input.files[0]);
        }

        function dataLog(msg) {
            var el = document.getElementById('dataLog');
            el.textContent += '\n' + new Date().toLocaleTimeString('th-TH') + ' ' + msg;
            el.scrollTop = el.scrollHeight;
        }

        // ===== Tab 4: Audit Log =====
        function loadAuditLog() {
            if (typeof FirebaseService !== 'undefined' && FirebaseService.getAuditLog) {
                FirebaseService.getAuditLog(50).then(function(logs) {
                    renderAuditLog(logs);
                }).catch(function() {
                    document.getElementById('auditLogList').innerHTML = '<div class="empty-state">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
                });
            } else {
                document.getElementById('auditLogList').innerHTML = '<div class="empty-state">Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>';
            }
        }

        function renderAuditLog(logs) {
            if (!logs.length) {
                document.getElementById('auditLogList').innerHTML = '<div class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>';
                return;
            }

            var actionIcons = {
                create_staff: '‚ûï', update_staff: '‚úèÔ∏è', delete_staff: 'üóëÔ∏è',
                toggle_staff_status: 'üîÑ', seed_data: 'üå±', clear_all_data: '‚ö†Ô∏è',
                export_data: 'üì•', login: 'üîë'
            };

            var html = '';
            logs.forEach(function(log) {
                var icon = actionIcons[log.action] || 'üìù';
                var time = log.timestamp ? new Date(log.timestamp).toLocaleString('th-TH') : '-';
                html += '<div class="audit-item">' +
                    '<div class="audit-header">' +
                    '<span class="audit-icon">' + icon + '</span>' +
                    '<span class="audit-action">' + (log.details || log.action) + '</span>' +
                    '</div>' +
                    '<div class="audit-meta">‡πÇ‡∏î‡∏¢: ' + (log.performedBy || '-') + ' | ' + time + '</div>' +
                    '</div>';
            });
            document.getElementById('auditLogList').innerHTML = html;
        }

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', function() {
            var user = JSON.parse(localStorage.getItem('healthdesk_user'));

            // Auth guard: only superadmin can access
            if (!user || user.role !== 'superadmin') {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
                window.location.href = 'login.html';
                return;
            }

            // Display user info
            document.getElementById('userRoleDisplay').textContent = user.name + ' (' + user.roleLabel + ')';

            var dateEl = document.getElementById('currentDate');
            if (dateEl) {
                dateEl.textContent = new Date().toLocaleDateString('th-TH', {
                    year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
                });
            }

            // Init nav
            initNavFeatures('super-admin.html');

            // Load all data
            loadOverviewStats();
            loadStaff();
            loadDataSummary();
            loadAuditLog();
        });
    </script>
</body>
</html>
